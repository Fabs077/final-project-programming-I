<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio de Respiracion - Ira</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Estilos especificos de esta pagina */
        body {
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a0a0a;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: 1;
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas" class="exercise-canvas"></canvas>
    <div class="overlay"></div>

    <div class="content-layer">
        <div id="breathing-container" class="fade-in">
            <div class="circle-wrapper">
                <div id="breathing-circle" class="breathing-circle"></div>
                <p id="instruction-text" class="instruction-text">Inhala</p>
            </div>
        </div>

        <div id="question-container" class="hidden text-center">
            <p class="text-white text-2xl md:text-3xl font-light mb-8 tracking-wide">
                {{ config.messages.question }}
            </p>
            <div class="flex gap-6 justify-center">
                <button id="btn-yes" class="btn-response btn-yes">Si</button>
                <button id="btn-no" class="btn-response btn-no">No</button>
            </div>
        </div>

        <div id="final-message" class="hidden text-center">
            <p class="text-white text-3xl md:text-4xl font-light tracking-wide">
                {{ config.messages.success }}
            </p>
        </div>
    </div>

    <a href="/?show=main" class="back-button">‚Üê Volver</a>

    <script src="/utils.js"></script>
    <script>
        // Configuracion desde parameters.py
        const CONFIG = {
            inhaleTime: {{ config.inhale_time }} * 1000,
            holdTime: {{ config.hold_time }} * 1000,
            exhaleTime: {{ config.exhale_time }} * 1000,
            cycles: {{ config.cycles }},
            scaleInhale: 2.2,
            scaleExhale: 1,
            fadeTime: {{ general.fade_duration }} * 1000,
            messageTime: {{ general.message_display_time }} * 1000
        };

        // Colores desde parameters.py
        const COLORS = {
            red: {{ config.colors.red | tojson }},
            redToYellow: {{ config.colors.red_to_yellow | tojson }},
            yellowToViolet: {{ config.colors.yellow_to_violet | tojson }}
        };

        // Canvas - usando funciones de utils.js
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        setupCanvas(canvas);

        function drawBackground(color) {
            drawRadialGradient(ctx, canvas, color, 0.15, 0.1, 0.1, 0.0005);
        }

        // Elementos
        const circle = document.getElementById('breathing-circle');
        const text = document.getElementById('instruction-text');
        const breathingContainer = document.getElementById('breathing-container');
        const questionContainer = document.getElementById('question-container');
        const finalMessage = document.getElementById('final-message');

        // Estado
        let isRunning = true;
        let startTime = Date.now();
        const cycleDuration = CONFIG.inhaleTime + CONFIG.holdTime + CONFIG.exhaleTime;
        const inhaleEnd = CONFIG.inhaleTime / cycleDuration;
        const holdEnd = (CONFIG.inhaleTime + CONFIG.holdTime) / cycleDuration;

        // Animacion principal
        function animate() {
            if (!isRunning) return;

            const elapsed = (Date.now() - startTime) % cycleDuration;
            const progress = elapsed / cycleDuration;
            
            let phase, phaseProgress, colorArr;
            
            if (progress < inhaleEnd) {
                phase = 'inhale';
                phaseProgress = progress / inhaleEnd;
                colorArr = COLORS.red;
            } else if (progress < holdEnd) {
                phase = 'hold';
                phaseProgress = (progress - inhaleEnd) / (holdEnd - inhaleEnd);
                colorArr = COLORS.redToYellow;
            } else {
                phase = 'exhale';
                phaseProgress = (progress - holdEnd) / (1 - holdEnd);
                colorArr = COLORS.yellowToViolet;
            }

            const easedProgress = easeInOutCubic(phaseProgress);
            const color = getColorFromArray(colorArr, easedProgress);

            // Dibujar fondo
            drawBackground(color);

            // Actualizar circulo
            let scale;
            if (phase === 'inhale') {
                scale = lerp(1, CONFIG.scaleInhale, easeOutCubic(phaseProgress));
                circle.classList.remove('shake');
            } else if (phase === 'hold') {
                scale = CONFIG.scaleInhale;
                circle.classList.add('shake');
            } else {
                scale = lerp(CONFIG.scaleInhale, CONFIG.scaleExhale, easeInCubic(phaseProgress));
                circle.classList.remove('shake');
            }

            circle.style.transform = `scale(${scale})`;
            
            const glow = scale / CONFIG.scaleInhale;
            circle.style.background = `linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.1)) padding-box, linear-gradient(135deg, rgb(${color.r}, ${color.g}, ${color.b}), rgb(${Math.min(255, color.r + 40)}, ${Math.min(255, color.g + 40)}, ${Math.min(255, color.b + 40)})) border-box`;
            circle.style.boxShadow = `0 0 ${50 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.7), 0 0 ${100 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.5), 0 0 ${150 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.3), inset 0 0 ${50 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.3)`;

            // Actualizar texto
            if (phase === 'inhale') {
                text.textContent = 'Inhala';
                text.classList.remove('text-fade-blur');
            } else if (phase === 'hold') {
                text.textContent = 'Manten';
                text.classList.remove('text-fade-blur');
            } else {
                text.textContent = 'Exhala';
                if (phaseProgress > 0.3) text.classList.add('text-fade-blur');
            }

            // Verificar fin
            const totalElapsed = Date.now() - startTime;
            if (totalElapsed >= cycleDuration * CONFIG.cycles) {
                showQuestion();
                return;
            }

            requestAnimationFrame(animate);
        }

        function showQuestion() {
            isRunning = false;
            breathingContainer.classList.add('fade-out');
            setTimeout(() => {
                breathingContainer.classList.add('hidden');
                questionContainer.classList.remove('hidden');
                questionContainer.classList.add('fade-in');
            }, CONFIG.fadeTime);
        }

        function restart() {
            questionContainer.classList.add('fade-out');
            setTimeout(() => {
                questionContainer.classList.add('hidden');
                questionContainer.classList.remove('fade-in', 'fade-out');
                breathingContainer.classList.remove('hidden', 'fade-out');
                breathingContainer.classList.add('fade-in');
                text.textContent = 'Inhala';
                text.classList.remove('text-fade-blur');
                isRunning = true;
                startTime = Date.now();
                animate();
            }, CONFIG.fadeTime);
        }

        // Iniciar
        animate();

        // Eventos
        document.getElementById('btn-yes').addEventListener('click', () => {
            questionContainer.classList.add('fade-out');
            setTimeout(() => {
                questionContainer.classList.add('hidden');
                finalMessage.classList.remove('hidden');
                finalMessage.classList.add('fade-in');
                setTimeout(() => {
                    finalMessage.classList.add('fade-out');
                    setTimeout(() => {
                        window.location.href = '/?show=main';
                    }, CONFIG.fadeTime);
                }, CONFIG.messageTime);
            }, CONFIG.fadeTime);
        });

        document.getElementById('btn-no').addEventListener('click', restart);
    </script>
</body>
</html>
