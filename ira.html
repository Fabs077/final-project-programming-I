<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio de Respiracion - Ira</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a0a0a;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .content-layer {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .circle-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 330px;
            height: 330px;
        }

        .breathing-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 6px solid transparent;
            position: absolute;
        }

        .instruction-text {
            position: relative;
            z-index: 10;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 300;
            color: white;
            letter-spacing: 0.2em;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transition: opacity 1s ease-in-out, filter 1s ease-in-out;
        }

        .text-fade-blur {
            opacity: 0;
            filter: blur(15px);
        }

        @keyframes shake {
            0%, 100% { margin-left: 0; }
            20% { margin-left: -4px; }
            40% { margin-left: 4px; }
            60% { margin-left: -4px; }
            80% { margin-left: 4px; }
        }

        .shake {
            animation: shake 0.4s ease-in-out infinite;
        }

        .fade-in { animation: fadeIn 1s ease-in forwards; }
        .fade-out { animation: fadeOut 1s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .hidden { display: none !important; }

        .btn-response {
            padding: 12px 32px;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .btn-yes {
            background: rgba(139, 92, 246, 0.3);
            border: 2px solid rgba(139, 92, 246, 0.5);
            color: white;
        }

        .btn-yes:hover {
            background: rgba(139, 92, 246, 0.5);
            transform: scale(1.05);
        }

        .btn-no {
            background: rgba(220, 38, 38, 0.3);
            border: 2px solid rgba(220, 38, 38, 0.5);
            color: white;
        }

        .btn-no:hover {
            background: rgba(220, 38, 38, 0.5);
            transform: scale(1.05);
        }

        .back-button {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            border: 1px solid rgba(255,255,255,0.3);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-50%) scale(1.05);
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div class="overlay"></div>

    <div class="content-layer">
        <div id="breathing-container" class="fade-in">
            <div class="circle-wrapper">
                <div id="breathing-circle" class="breathing-circle"></div>
                <p id="instruction-text" class="instruction-text">Inhala</p>
            </div>
        </div>

        <div id="question-container" class="hidden text-center">
            <p class="text-white text-2xl md:text-3xl font-light mb-8 tracking-wide">
                {{ config.messages.question }}
            </p>
            <div class="flex gap-6 justify-center">
                <button id="btn-yes" class="btn-response btn-yes">Si</button>
                <button id="btn-no" class="btn-response btn-no">No</button>
            </div>
        </div>

        <div id="final-message" class="hidden text-center">
            <p class="text-white text-3xl md:text-4xl font-light tracking-wide">
                {{ config.messages.success }}
            </p>
        </div>
    </div>

    <a href="/?show=main" class="back-button">‚Üê Volver</a>

    <script>
        // Configuracion
        const CONFIG = {
            inhaleTime: 4000,
            holdTime: 7000,
            exhaleTime: 8000,
            cycles: 2,
            scaleInhale: 2.2,
            scaleExhale: 1,
            fadeTime: 1000,
            messageTime: 2000
        };

        // Colores en RGB (ya convertidos)
        const COLORS = {
            // ROJO (Inhalar)
            red: [
                {r: 127, g: 29, b: 29},
                {r: 153, g: 27, b: 27},
                {r: 185, g: 28, b: 28},
                {r: 220, g: 38, b: 38},
                {r: 239, g: 68, b: 68},
                {r: 248, g: 113, b: 113}
            ],
            // ROJO -> AMARILLO (Mantener)
            redToYellow: [
                {r: 239, g: 68, b: 68},
                {r: 234, g: 88, b: 12},
                {r: 249, g: 115, b: 22},
                {r: 251, g: 146, b: 60},
                {r: 253, g: 186, b: 116},
                {r: 251, g: 191, b: 36},
                {r: 252, g: 211, b: 77},
                {r: 250, g: 204, b: 21},
                {r: 253, g: 224, b: 71}
            ],
            // AMARILLO -> VIOLETA (Exhalar)
            yellowToViolet: [
                {r: 253, g: 224, b: 71},
                {r: 163, g: 230, b: 53},
                {r: 74, g: 222, b: 128},
                {r: 45, g: 212, b: 191},
                {r: 34, g: 211, b: 238},
                {r: 56, g: 189, b: 248},
                {r: 96, g: 165, b: 250},
                {r: 59, g: 130, b: 246},
                {r: 99, g: 102, b: 241},
                {r: 139, g: 92, b: 246},
                {r: 167, g: 139, b: 250}
            ]
        };

        // Utilidades
        function lerp(a, b, t) {
            return a + (b - a) * t;
        }

        function lerpColor(c1, c2, t) {
            return {
                r: Math.round(lerp(c1.r, c2.r, t)),
                g: Math.round(lerp(c1.g, c2.g, t)),
                b: Math.round(lerp(c1.b, c2.b, t))
            };
        }

        function getColorFromArray(arr, progress) {
            const idx = progress * (arr.length - 1);
            const lo = Math.floor(idx);
            const hi = Math.min(lo + 1, arr.length - 1);
            return lerpColor(arr[lo], arr[hi], idx - lo);
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        function easeInCubic(t) {
            return t * t * t;
        }

        // Canvas
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function drawBackground(color) {
            const w = canvas.width;
            const h = canvas.height;
            
            // Fondo base oscuro
            ctx.fillStyle = `rgb(${Math.floor(color.r * 0.15)}, ${Math.floor(color.g * 0.1)}, ${Math.floor(color.b * 0.1)})`;
            ctx.fillRect(0, 0, w, h);
            
            // Gradientes animados
            const time = Date.now() * 0.0005;
            const points = [
                {x: 0.2 + Math.sin(time) * 0.05, y: 0.2 + Math.cos(time * 0.8) * 0.05},
                {x: 0.8 + Math.cos(time * 1.2) * 0.05, y: 0.2 + Math.sin(time) * 0.05},
                {x: 0.5 + Math.sin(time * 0.7) * 0.05, y: 0.5 + Math.cos(time * 1.1) * 0.05},
                {x: 0.7 + Math.cos(time * 0.9) * 0.05, y: 0.8 + Math.sin(time * 0.6) * 0.05},
                {x: 0.3 + Math.sin(time * 1.3) * 0.05, y: 0.8 + Math.cos(time * 0.5) * 0.05}
            ];
            
            points.forEach((p, i) => {
                const grad = ctx.createRadialGradient(p.x * w, p.y * h, 0, p.x * w, p.y * h, w * 0.5);
                const alpha = 0.4 + Math.sin(time + i) * 0.1;
                grad.addColorStop(0, `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`);
                grad.addColorStop(0.5, `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha * 0.3})`);
                grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, w, h);
            });
        }

        // Elementos
        const circle = document.getElementById('breathing-circle');
        const text = document.getElementById('instruction-text');
        const breathingContainer = document.getElementById('breathing-container');
        const questionContainer = document.getElementById('question-container');
        const finalMessage = document.getElementById('final-message');

        // Estado
        let isRunning = true;
        let startTime = Date.now();
        const cycleDuration = CONFIG.inhaleTime + CONFIG.holdTime + CONFIG.exhaleTime;
        const inhaleEnd = CONFIG.inhaleTime / cycleDuration;
        const holdEnd = (CONFIG.inhaleTime + CONFIG.holdTime) / cycleDuration;

        // Animacion principal
        function animate() {
            if (!isRunning) return;

            const elapsed = (Date.now() - startTime) % cycleDuration;
            const progress = elapsed / cycleDuration;
            
            let phase, phaseProgress, colorArr;
            
            if (progress < inhaleEnd) {
                phase = 'inhale';
                phaseProgress = progress / inhaleEnd;
                colorArr = COLORS.red;
            } else if (progress < holdEnd) {
                phase = 'hold';
                phaseProgress = (progress - inhaleEnd) / (holdEnd - inhaleEnd);
                colorArr = COLORS.redToYellow;
            } else {
                phase = 'exhale';
                phaseProgress = (progress - holdEnd) / (1 - holdEnd);
                colorArr = COLORS.yellowToViolet;
            }

            const easedProgress = easeInOutCubic(phaseProgress);
            const color = getColorFromArray(colorArr, easedProgress);

            // Dibujar fondo
            drawBackground(color);

            // Actualizar circulo
            let scale;
            if (phase === 'inhale') {
                scale = lerp(1, CONFIG.scaleInhale, easeOutCubic(phaseProgress));
                circle.classList.remove('shake');
            } else if (phase === 'hold') {
                scale = CONFIG.scaleInhale;
                circle.classList.add('shake');
            } else {
                scale = lerp(CONFIG.scaleInhale, CONFIG.scaleExhale, easeInCubic(phaseProgress));
                circle.classList.remove('shake');
            }

            circle.style.transform = `scale(${scale})`;
            
            const glow = scale / CONFIG.scaleInhale;
            circle.style.background = `linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.1)) padding-box, linear-gradient(135deg, rgb(${color.r}, ${color.g}, ${color.b}), rgb(${Math.min(255, color.r + 40)}, ${Math.min(255, color.g + 40)}, ${Math.min(255, color.b + 40)})) border-box`;
            circle.style.boxShadow = `0 0 ${50 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.7), 0 0 ${100 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.5), 0 0 ${150 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.3), inset 0 0 ${50 * glow}px rgba(${color.r}, ${color.g}, ${color.b}, 0.3)`;

            // Actualizar texto
            if (phase === 'inhale') {
                text.textContent = 'Inhala';
                text.classList.remove('text-fade-blur');
            } else if (phase === 'hold') {
                text.textContent = 'Manten';
                text.classList.remove('text-fade-blur');
            } else {
                text.textContent = 'Exhala';
                if (phaseProgress > 0.3) text.classList.add('text-fade-blur');
            }

            // Verificar fin
            const totalElapsed = Date.now() - startTime;
            if (totalElapsed >= cycleDuration * CONFIG.cycles) {
                showQuestion();
                return;
            }

            requestAnimationFrame(animate);
        }

        function showQuestion() {
            isRunning = false;
            breathingContainer.classList.add('fade-out');
            setTimeout(() => {
                breathingContainer.classList.add('hidden');
                questionContainer.classList.remove('hidden');
                questionContainer.classList.add('fade-in');
            }, CONFIG.fadeTime);
        }

        function restart() {
            questionContainer.classList.add('fade-out');
            setTimeout(() => {
                questionContainer.classList.add('hidden');
                questionContainer.classList.remove('fade-in', 'fade-out');
                breathingContainer.classList.remove('hidden', 'fade-out');
                breathingContainer.classList.add('fade-in');
                text.textContent = 'Inhala';
                text.classList.remove('text-fade-blur');
                isRunning = true;
                startTime = Date.now();
                animate();
            }, CONFIG.fadeTime);
        }

        // Iniciar
        animate();

        // Eventos
        document.getElementById('btn-yes').addEventListener('click', () => {
            questionContainer.classList.add('fade-out');
            setTimeout(() => {
                questionContainer.classList.add('hidden');
                finalMessage.classList.remove('hidden');
                finalMessage.classList.add('fade-in');
                setTimeout(() => {
                    finalMessage.classList.add('fade-out');
                    setTimeout(() => {
                        window.location.href = '/?show=main';
                    }, CONFIG.fadeTime);
                }, CONFIG.messageTime);
            }, CONFIG.fadeTime);
        });

        document.getElementById('btn-no').addEventListener('click', restart);
    </script>
</body>
</html>
